%% Define saccade parameters
% Note: the lambda is set high to account for blinks that appear
% curved/smooth pursuit like.
params.saccade.fill_missing_data = false;
params.saccade.smoothen = true;
params.saccade.sampling_rate = 1000;
params.saccade.fix_vel_thres = 30;
params.saccade.lambda = 20;
params.saccade.combine_intv_thres = 20;
params.saccade.saccade_dur_thres = 5;
params.saccade.saccade_amp_thres = 0.2;

%% Define input data
data_in = []; data_in = bf_data_1500_ramping;

%% Extract saccade raster
for neuron_i = 1:size(data_in,1)
    sacc_raster = zeros(size(data_in.rasters{neuron_i},1),length(params.eye.alignWin));
    filename = data_in.filename{neuron_i};
    fprintf('Extracting saccade information from neuron %i of %i   |  %s   \n',neuron_i,size(data_in,1), filename)
    
    % For each trial, determine the time of saccades
    for trial_i = 1:size(data_in.rasters{neuron_i},1)
        
        % Get eye trace (X,Y)
        eyetrace = [];
        eyetrace = [data_in.eye{neuron_i}.eye_x{1,1}(trial_i,:)',...
            data_in.eye{neuron_i}.eye_y{1,1}(trial_i,:)'];
        
        % Run saccade extraction
        saccade_info = [];
        [saccade_info,~] = saccade_detector(eyetrace,params);
        
        if ~isempty(saccade_info)
            % Get time of saccade execution
            sacc_times = [];
            sacc_times = saccade_info(:,2);
            
            sacc_raster(trial_i,sacc_times) = 1;
        end
    end
    
    sacc_raster_out{neuron_i,1} = sacc_raster;
end


%%

trial_type_in = 'prob50';

for neuron_i = 1:size(data_in,1)

    % Saccade raster
    sacc_raster_in = [];
    sacc_raster_in = sacc_raster_out{neuron_i,1}(data_in.trials{neuron_i}.(trial_type_in),:);
    
    sacc_times = [];
    [~,sacc_times] = find(sacc_raster_in == 1);
    sacc_times = sacc_times - find(params.eye.alignWin == 0);
    
    % Spike raster
    spk_raster_in = [];
    spk_raster_in = data_in.rasters{neuron_i}(data_in.trials{neuron_i}.(trial_type_in),:);
    
    spk_times = [];
    [~,spk_times] = find(spk_raster_in == 1);
    spk_times = spk_times - find([-5000:1:5000] == 0);

    
    sacc_bin_counts = []; spk_bin_counts = [];
    sacc_bin_counts = histcounts(sacc_times, -1000:100:2000);
    spk_bin_counts = histcounts(spk_times, -1000:100:2000);

    [test_corr_values_r(neuron_i,1),...
        test_corr_values_p(neuron_i,1)] = corr(sacc_bin_counts',spk_bin_counts');
    
    switch test_corr_values_p
        case
    sig_label{neuron_i} test_corr_values_p
    
    
end

%% Figure: Histogram of correlation values

clear motor_corr_histogram
motor_corr_histogram(1,1) = gramm('x',test_corr_values_r);
motor_corr_histogram(1,1).stat_bin('edges',[-1:0.1:1]);
motor_corr_histogram(1,1).axe_property('XLim',[-1 1],'YLim',[0 20]);
motor_corr_histogram(1,1).set_names('x','nSaccade x nSpike r-value');
figure;
motor_corr_histogram.draw
